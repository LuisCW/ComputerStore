@page
@model ComputerStore.Pages.IndexModel
@inject ComputerStore.Services.LittleCarService CarritoService

<div class="container-fluid px-0">
    <!-- Hero Section -->
    <section class="hero-section position-relative overflow-hidden text-white text-center">
        <div class="hero-overlay position-absolute top-0 start-0 w-100 h-100"></div>
        <div class="container position-relative z-1">
            <h1 class="display-4 fw-bold mb-4">Tecnología de Próxima Generación</h1>
            <p class="lead mb-5">Descubre los últimos avances en computación y gaming</p>
            <a href="/Products" class="btn btn-primary btn-lg px-5 py-3">Explorar Catálogo</a>
        </div>
    </section>

    <!-- Sección de Productos Destacados -->
    <section class="py-5">
        <div class="container">
            <h2 class="text-center mb-5">Productos Destacados</h2>
            <div class="row">
                @foreach (var producto in Model.DestacadosProductos)
                {
                    var ahorro = (producto.OriginalPrice.HasValue && producto.OriginalPrice.Value > 0 && producto.OriginalPrice.Value > producto.Price) ? producto.OriginalPrice.Value - producto.Price : 0;
                    var pct = (producto.OriginalPrice.HasValue && producto.OriginalPrice.Value > 0 && producto.OriginalPrice.Value > producto.Price) ? Math.Round((ahorro / producto.OriginalPrice.Value) * 100) : 0;
                    var agotado = producto.Stock <= 0 || string.Equals(producto.Availability?.Trim(), "Agotado", StringComparison.OrdinalIgnoreCase);
                    <div class="col-md-4 mb-4">
                        <div class="card shadow-sm h-100 product-card position-relative"
                             data-id="@producto.Id"
                             data-name="@producto.Name"
                             data-description="@producto.Description"
                             data-price="@producto.Price"
                             data-brand="@producto.Brand"
                             data-availability="@producto.Availability"
                             data-stock="@producto.Stock"
                             data-campaign="@producto.CampaignName"
                             data-details='@Html.Raw(Json.Serialize(producto.Details))'>
                            @await Html.PartialAsync("_ProductCarousel", producto)
                            @if (agotado)
                            {
                                <span class="badge bg-secondary position-absolute top-0 start-0 m-2">Agotado</span>
                            }
                            else if (pct > 0)
                            {
                                <span class="badge bg-danger position-absolute top-0 start-0 m-2">-@pct% OFF</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(producto.CampaignName))
                            {
                                <span class="badge bg-info position-absolute top-0 end-0 m-2"><i class="fas fa-bullhorn me-1"></i>@producto.CampaignName</span>
                            }
                            <div class="card-body">
                                <h5 class="card-title">@producto.Name</h5>
                                <p class="card-text product-desc-2lines">@producto.Description</p>
                                @if (producto.OriginalPrice.HasValue && producto.OriginalPrice.Value > 0 && producto.OriginalPrice.Value > producto.Price)
                                {
                                    <p class="card-text"><span class="text-muted text-decoration-line-through me-2 old-price">$@producto.OriginalPrice.Value.ToString("N0")</span><span class="fw-bold text-success new-price">$@producto.Price.ToString("N0")</span></p>
                                }
                                else
                                {
                                    <p class="card-text fw-bold new-price">$@producto.Price.ToString("N0")</p>
                                }
                                <div class="d-flex justify-content-between align-items-center">
                                    <button class="btn btn-primary details-btn">Ver Detalles</button>
                                    <button type="button" class="btn @(agotado?"btn-secondary":"btn-success") btn-sm add-to-cart-btn" data-product-id="@producto.Id" data-product-name="@producto.Name" @(agotado?"disabled":"")]>
                                        <i class="fas fa-cart-plus me-1"></i>@(agotado?"Agotado":"Agregar")
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </section>

    <!-- Sección de Nuevos Productos -->
    <section class="py-5 bg-light nuevos-productos-section">
        <div class="container">
            <h2 class="text-center mb-5">Nuevos Lanzamientos</h2>
            <div class="row">
                @foreach (var producto in Model.NuevosProductos)
                {
                    var ahorro2 = (producto.OriginalPrice.HasValue && producto.OriginalPrice.Value > 0 && producto.OriginalPrice.Value > producto.Price) ? producto.OriginalPrice.Value - producto.Price : 0;
                    var pct2 = (producto.OriginalPrice.HasValue && producto.OriginalPrice.Value > 0 && producto.OriginalPrice.Value > producto.Price) ? Math.Round((ahorro2 / producto.OriginalPrice.Value) * 100) : 0;
                    var agotado2 = producto.Stock <= 0 || string.Equals(producto.Availability?.Trim(), "Agotado", StringComparison.OrdinalIgnoreCase);
                    <div class="col-md-4 mb-4">
                        <div class="card shadow-sm h-100 product-card position-relative"
                             data-id="@producto.Id" data-name="@producto.Name" data-description="@producto.Description" data-price="@producto.Price" data-brand="@producto.Brand" data-availability="@producto.Availability" data-stock="@producto.Stock" data-campaign="@producto.CampaignName" data-details='@Html.Raw(Json.Serialize(producto.Details))'>
                            @await Html.PartialAsync("_ProductCarousel", producto)
                            @if (agotado2)
                            {
                                <span class="badge bg-secondary position-absolute top-0 start-0 m-2">Agotado</span>
                            }
                            else if (pct2 > 0)
                            {
                                <span class="badge bg-danger position-absolute top-0 start-0 m-2">-@pct2% OFF</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(producto.CampaignName))
                            {
                                <span class="badge bg-info position-absolute top-0 end-0 m-2"><i class="fas fa-bullhorn me-1"></i>@producto.CampaignName</span>
                            }
                            <div class="card-body">
                                <h5 class="card-title">@producto.Name</h5>
                                <p class="card-text product-desc-2lines">@producto.Description</p>
                                @if (producto.OriginalPrice.HasValue && producto.OriginalPrice.Value > 0 && producto.OriginalPrice.Value > producto.Price)
                                {
                                    <p class="card-text"><span class="text-muted text-decoration-line-through me-2 old-price">$@producto.OriginalPrice.Value.ToString("N0")</span><span class="fw-bold text-success new-price">$@producto.Price.ToString("N0")</span></p>
                                }
                                else
                                {
                                    <p class="card-text fw-bold new-price">$@producto.Price.ToString("N0")</p>
                                }
                                <div class="d-flex justify-content-between align-items-center">
                                    <button class="btn btn-primary details-btn">Ver Detalles</button>
                                    <button type="button" class="btn @(agotado2?"btn-secondary":"btn-success") btn-sm add-to-cart-btn" data-product-id="@producto.Id" data-product-name="@producto.Name" @(agotado2?"disabled":"")]>
                                        <i class="fas fa-cart-plus me-1"></i>@(agotado2?"Agotado":"Agregar")
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </section>

    <!-- Sección de Más Vendidos -->
    <section class="py-5">
        <div class="container">
            <h2 class="text-center mb-5">Más Vendidos</h2>
            <div class="row">
                @foreach (var producto in Model.MasVendidosProductos)
                {
                    var ahorro3 = (producto.OriginalPrice.HasValue && producto.OriginalPrice.Value > 0 && producto.OriginalPrice.Value > producto.Price) ? producto.OriginalPrice.Value - producto.Price : 0;
                    var pct3 = (producto.OriginalPrice.HasValue && producto.OriginalPrice.Value > 0 && producto.OriginalPrice.Value > producto.Price) ? Math.Round((ahorro3 / producto.OriginalPrice.Value) * 100) : 0;
                    var agotado3 = producto.Stock <= 0 || string.Equals(producto.Availability?.Trim(), "Agotado", StringComparison.OrdinalIgnoreCase);
                    <div class="col-md-4 mb-4">
                        <div class="card shadow-sm h-100 product-card position-relative"
                             data-id="@producto.Id" data-name="@producto.Name" data-description="@producto.Description" data-price="@producto.Price" data-brand="@producto.Brand" data-availability="@producto.Availability" data-stock="@producto.Stock" data-campaign="@producto.CampaignName" data-details='@Html.Raw(Json.Serialize(producto.Details))'>
                            @await Html.PartialAsync("_ProductCarousel", producto)
                            @if (agotado3)
                            {
                                <span class="badge bg-secondary position-absolute top-0 start-0 m-2">Agotado</span>
                            }
                            else if (pct3 > 0)
                            {
                                <span class="badge bg-danger position-absolute top-0 start-0 m-2">-@pct3% OFF</span>
                            }
                            @if (!string.IsNullOrWhiteSpace(producto.CampaignName))
                            {
                                <span class="badge bg-info position-absolute top-0 end-0 m-2"><i class="fas fa-bullhorn me-1"></i>@producto.CampaignName</span>
                            }
                            <div class="card-body">
                                <h5 class="card-title">@producto.Name</h5>
                                <p class="card-text product-desc-2lines">@producto.Description</p>
                                @if (producto.OriginalPrice.HasValue && producto.OriginalPrice.Value > 0 && producto.OriginalPrice.Value > producto.Price)
                                {
                                    <p class="card-text"><span class="text-muted text-decoration-line-through me-2 old-price">$@producto.OriginalPrice.Value.ToString("N0")</span><span class="fw-bold text-success new-price">$@producto.Price.ToString("N0")</span></p>
                                }
                                else
                                {
                                    <p class="card-text fw-bold new-price">$@producto.Price.ToString("N0")</p>
                                }
                                <div class="d-flex justify-content-between align-items-center">
                                    <button class="btn btn-primary details-btn">Ver Detalles</button>
                                    <button type="button" class="btn @(agotado3?"btn-secondary":"btn-success") btn-sm add-to-cart-btn" data-product-id="@producto.Id" data-product-name="@producto.Name" @(agotado3?"disabled":"")]>
                                        <i class="fas fa-cart-plus me-1"></i>@(agotado3?"Agotado":"Agregar")
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </section>

    <!-- Modal de Detalles de Producto (versión de Productos) -->
    <div id="productModal" class="modal fade" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="productModalLabel">
                        <i class="fas fa-info-circle me-2"></i>Detalles del Producto
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="carousel slide" data-bs-ride="carousel">
                                <div class="carousel-inner"></div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#productModal .carousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#productModal .carousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h3 id="modalProductName" class="text-primary mb-2"></h3>
                            <div id="modalCampaignBadge" class="mb-2"></div>
                            <p id="modalProductDescription" class="text-muted mb-3"></p>
                            <div class="mb-3">
                                <h4 class="text-success">
                                    <i class="fas fa-tag me-2"></i>
                                    <span id="modalProductPrice"></span>
                                </h4>
                            </div>
                            <div class="mb-3">
                                <h6 class="fw-bold">
                                    <i class="fas fa-award me-2"></i>Marca: 
                                    <span id="modalProductBrand" class="text-primary"></span>
                                </h6>
                            </div>
                            <div class="mb-4">
                                <h6 class="fw-bold mb-2">
                                    <i class="fas fa-cogs me-2"></i>Especificaciones:
                                </h6>
                                <div id="modalProductDetails" class="row"></div>
                            </div>
                            <div class="mb-3">
                                <span id="modalProductAvailability" class="badge"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cerrar
                    </button>
                    <button type="button" class="btn btn-primary btn-lg add-to-cart-btn"
                            id="modalAddToCartBtn"
                            data-product-id=""
                            data-product-name="">
                        <i class="fas fa-cart-plus me-2"></i>Agregar al Carrito
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@Html.AntiForgeryToken()

<style>
    .hero-section {
        background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1498050108023-c5249f4df085?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1472&q=80');
        background-size: cover;
        background-position: center;
        height: 80vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .product-card { cursor: pointer; }

    /* Descripción a 2 líneas */
    .product-desc-2lines { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; min-height: 3rem; }

    body.dark-theme { background-color: #121212; color: #e0e0e0; }
    body.dark-theme .card { background-color: #1f1f1f; color: #e0e0e0; border-color: #333; }
    body.dark-theme .modal-content { background-color: #1f1f1f; color: #e0e0e0; border-color: #333; }
    body.dark-theme .nuevos-productos-section { background-color: #1f1f1f !important; color: #e0e0e0; }
    body.dark-theme .hero-section { background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1498050108023-c5249f4df085?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1472&q=80') !important; }
    body.dark-theme h2, body.dark-theme h5, body.dark-theme .card-title { color: #e0e0e0 !important; }
    body.dark-theme .text-muted, body.dark-theme .card-text { color: #b0b0b0 !important; }
    body.dark-theme .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb) !important; border-color: #3b82f6 !important; color: white !important; }
    body.dark-theme .details-btn { background: linear-gradient(135deg, #3b82f6, #2563eb) !important; border-color: #3b82f6 !important; color: white !important; }

    /* FIX: Forzar que text-dark en dark-theme sea visible */
    body.dark-theme .text-dark,
    body.dark-theme .modal .text-dark { color: #e0e0e0 !important; }

    /* Efecto hover en las product cards */
    .product-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .product-card:hover {
        transform: translateY(-8px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15) !important;
 }

    body.dark-theme .product-card:hover {
     box-shadow: 0 12px 24px rgba(59, 130, 246, 0.3) !important;
    }

    .product-card .btn {
        transition: all 0.2s ease;
    }

    .product-card:hover .btn-primary {
        transform: scale(1.05);
    }
</style>

<script>
    // Modo oscuro
    const themeToggle = document.getElementById("themeToggle");
    const savedTheme = localStorage.getItem('darkMode');
    if (savedTheme === 'true') { document.body.classList.add("dark-theme"); if (themeToggle) { themeToggle.textContent = "Cambiar a Modo Claro"; } }
    window.addEventListener('storage', (e) => {
        if (e.key === 'darkMode') {
            if (e.newValue === 'true') { document.body.classList.add("dark-theme"); if (themeToggle) { themeToggle.textContent = "Cambiar a Modo Claro"; } }
            else { document.body.classList.remove("dark-theme"); if (themeToggle) { themeToggle.textContent = "Cambiar a Modo Oscuro"; } }
        }
    });
    if (themeToggle) {
        themeToggle.addEventListener("click", () => {
            document.body.classList.toggle("dark-theme");
            const isDark = document.body.classList.contains("dark-theme");
            themeToggle.textContent = isDark ? "Cambiar a Modo Claro" : "Cambiar a Modo Oscuro";
            localStorage.setItem('darkMode', isDark);
        });
    }

    // Abrir modal con datos de la card
    document.querySelectorAll('.product-card').forEach(card => {
        card.addEventListener("click", (event) => {
      if (event.target.closest('.add-to-cart-btn')) { return; }
            const productId = card.dataset.id;
            const productName = card.dataset.name || card.querySelector('.card-title')?.textContent || '';
      const productDescription = card.dataset.description || card.querySelector('.card-text:not(.fw-bold)')?.textContent || '';
     const productBrand = card.dataset.brand || '';
         const availability = (card.dataset.availability || '').trim();
       const campaign = card.dataset.campaign || '';
       
        // Actualizar URL con el ID del producto
            const productSlug = productName.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '');
            const newUrl = `${window.location.pathname}?product=${productId}-${productSlug}`;
  window.history.pushState({ productId: productId }, '', newUrl);
         
      const modalButton = document.getElementById('modalAddToCartBtn');
          modalButton.setAttribute('data-product-id', productId);
      modalButton.setAttribute('data-product-name', productName);
        document.getElementById('modalProductName').textContent = productName;
        document.getElementById('modalProductDescription').textContent = productDescription;
    document.getElementById('modalProductBrand').textContent = productBrand || '—';
       const availabilityBadge = document.getElementById('modalProductAvailability');
     if (availability === 'Disponible') { availabilityBadge.className = 'badge bg-success fs-6'; availabilityBadge.innerHTML = '<i class="fas fa-check me-1"></i>Disponible'; modalButton.disabled = false; }
 else { availabilityBadge.className = 'badge bg-danger fs-6'; availabilityBadge.innerHTML = '<i class="fas fa-times me-1"></i>Agotado'; modalButton.disabled = true; }
            // Precio en modal (incluye original si existe)
     const oldEl = card.querySelector('.old-price');
            const newEl = card.querySelector('.new-price');
     if (oldEl && newEl) {
      document.getElementById('modalProductPrice').innerHTML = `<span class="text-muted text-decoration-line-through me-2">${oldEl.textContent}</span><span class="fw-bold text-success">${newEl.textContent}</span>`;
       } else if (newEl) {
 document.getElementById('modalProductPrice').innerHTML = `<span class="fw-bold">${newEl.textContent}</span>`;
            } else {
                const price = card.dataset.price ? Number(card.dataset.price).toLocaleString() : '';
    document.getElementById('modalProductPrice').innerText = price ? `$${price}` : '';
    }
            // Campaña en modal
            const campaignBadge = document.getElementById('modalCampaignBadge');
          if (campaign) {
              campaignBadge.innerHTML = `<span class="badge bg-info"><i class=\"fas fa-bullhorn me-1\"></i>${campaign}</span>`;
       } else { campaignBadge.innerHTML = ''; }
         // Detalles
            const productDetails = JSON.parse(card.dataset.details || '{}');
     const detailsContainer = document.getElementById('modalProductDetails');
 if (Object.keys(productDetails).length > 0) {
          detailsContainer.innerHTML = Object.entries(productDetails)
          .map(([key, value]) => `<div class=\"col-md-6 mb-2\"><strong class=\"text-muted\">${key}:</strong><br><span class=\"text-reset\">${value}</span></div>`)
   .join('');
       } else { detailsContainer.innerHTML = '<div class="col-12 text-muted">Sin especificaciones técnicas disponibles</div>'; }
   setupModalImageCarousel(card);
            const productModal = new bootstrap.Modal(document.getElementById('productModal'));
      productModal.show();
      });
    });

    // Restaurar URL al cerrar el modal
    const productModalElement = document.getElementById('productModal');
    productModalElement.addEventListener('hidden.bs.modal', () => {
        const urlParams = new URLSearchParams(window.location.search);
     urlParams.delete('product');
        const baseUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
     window.history.pushState({}, '', baseUrl);
    });

    // Abrir modal si hay un parámetro 'product' en la URL al cargar la página
    window.addEventListener('DOMContentLoaded', () => {
const urlParams = new URLSearchParams(window.location.search);
        const productParam = urlParams.get('product');
      if (productParam) {
      const productId = productParam.split('-')[0];
    const card = document.querySelector(`.product-card[data-id="${productId}"]`);
     if (card) {
   card.click();
   }
        }
    });

  function setupModalImageCarousel(productCard) {
        const carouselInner = document.querySelector('#productModal .carousel-inner');
        if (!carouselInner) return;
    carouselInner.innerHTML = '';
    const carousel = productCard.querySelector('.carousel');
        const images = [];
    if (carousel) {
       const carouselItems = carousel.querySelectorAll('.carousel-item img');
  carouselItems.forEach(img => { images.push({ src: img.src, alt: img.alt }); });
   } else {
        const mainImage = productCard.querySelector('img');
            if (mainImage) { images.push({ src: mainImage.src, alt: mainImage.alt }); }
     }
        if (images.length > 0) {
            images.forEach((image, index) => {
         const isActive = index === 0 ? 'active' : '';
     const item = document.createElement('div');
          item.className = `carousel-item ${isActive}`;
              item.innerHTML = `<img src="${image.src}" class="d-block w-100" alt="${image.alt}" style="height: 400px; object-fit: contain; background: #f8f9fa;">`;
         carouselInner.appendChild(item);
            });
    let indicators = document.querySelector('#productModal .carousel-indicators');
            if (!indicators) {
         indicators = document.createElement('div');
     indicators.className = 'carousel-indicators';
const car = document.querySelector('#productModal .carousel');
          if (car) { car.insertBefore(indicators, carouselInner); }
          }
       indicators.innerHTML = '';
 images.forEach((_, index) => {
           const indicator = document.createElement('button');
         indicator.type = 'button';
indicator.setAttribute('data-bs-target', '#productModal .carousel');
   indicator.setAttribute('data-bs-slide-to', index);
         indicator.className = index === 0 ? 'active' : '';
    indicators.appendChild(indicator);
            });
        } else {
            const item = document.createElement('div');
       item.className = 'carousel-item active';
 item.innerHTML = `<div class="d-flex align-items-center justify-content-center" style="height: 400px; background: #f8f9fa;"><div class="text-center text-muted"><i class="fas fa-image fa-4x mb-3"></i><p>Sin imagen disponible</p></div></div>`;
            carouselInner.appendChild(item);
        }
    }

    // Agregar al carrito
 document.addEventListener('click', (e) => {
     if (e.target.closest('.add-to-cart-btn')) {
  e.preventDefault(); e.stopPropagation();
            const button = e.target.closest('.add-to-cart-btn');
   const productId = button.getAttribute('data-product-id');
       const productName = button.getAttribute('data-product-name');
    if (productId) { addToCart(productId, productName, button); }
        }
    });

    async function addToCart(productId, productName, button) {
        const originalText = button.innerHTML; const originalDisabled = button.disabled;
 try {
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Agregando...'; button.disabled = true;
            const formData = new FormData(); formData.append('id', productId);
       formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
     const response = await fetch('?handler=AgregarAlCarrito', { method: 'POST', body: formData });
      if (!response.ok) { throw new Error(`Error HTTP: ${response.status}`); }
            const result = await response.json();
 if (result.success) {
        showToast(`${result.productName} agregado al carrito`, 'success');
           updateCartBadge(result.cartCount);
       button.innerHTML = '<i class="fas fa-check me-1"></i>¡Agregado!';
    button.classList.add('btn-success'); button.classList.remove('btn-primary');
         const modal = document.querySelector('.modal.show'); if (modal) { bootstrap.Modal.getInstance(modal).hide(); }
     setTimeout(() => { button.innerHTML = originalText; button.classList.remove('btn-success'); button.classList.add('btn-success'); button.disabled = originalDisabled; }, 2000);
 } else {
                if (result.requiresLogin) { showLoginModal(result.message); }
    else { throw new Error(result.message || 'Error al agregar producto'); }
 }
        } catch (error) {
       showToast(`Error: ${error.message}`, 'error'); button.innerHTML = originalText; button.disabled = originalDisabled;
      }
    }

    function showLoginModal(message) {
        let loginModal = document.getElementById('loginRequiredModal');
      if (!loginModal) {
    loginModal = document.createElement('div'); loginModal.id = 'loginRequiredModal'; loginModal.className = 'modal fade';
            loginModal.innerHTML = `
    <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title"><i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión Requerido</h5>
     <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
     </div>
       <div class="modal-body text-center">
<i class="fas fa-shopping-cart fa-3x text-warning mb-3"></i>
 <p class="mb-3">${message}</p>
  <p class="text-muted">Para acceder al carrito de compras y realizar pedidos, necesitas tener una cuenta.</p>
 </div>
<div class="modal-footer justify-content-center">
    <a href="/Account/Login" class="btn btn-primary"><i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión</a>
       <a href="/Account/Register" class="btn btn-success"><i class="fas fa-user-plus me-2"></i>Crear Cuenta</a>
       <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-2"></i>Cancelar</button>
    </div>
        </div>
</div>`;
            document.body.appendChild(loginModal);
        }
     const modal = new bootstrap.Modal(loginModal); modal.show();
    }

    function showToast(message, type = 'success') {
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) { toastContainer = document.createElement('div'); toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3'; document.body.appendChild(toastContainer); }
        const toastId = 'toast-' + Date.now(); const bgClass = type === 'success' ? 'bg-success' : 'bg-danger'; const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
     const toastHtml = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="4000">
      <div class="toast-header ${bgClass} text-white">
     <i class="${icon} me-2"></i>
        <strong class="me-auto">${type === 'success' ? '¡Éxito!' : 'Error'}</strong>
             <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
  </div>
    <div class="toast-body">
          ${message}
      ${type === 'success' ? `
  <div class="mt-2">
     <button class="btn btn-primary btn-sm me-2" onclick="window.location.href='/LittleCar'">
          <i class="fas fa-shopping-cart me-1"></i>Ver Carrito
        </button>
         <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="toast">
        <i class="fas fa-shopping-bag me-1"></i>Seguir Comprando
           </button>
               </div>` : ''}
              </div>
       </div>`;
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
   const toastElement = document.getElementById(toastId); const toast = new bootstrap.Toast(toastElement); toast.show();
        toastElement.addEventListener('hidden.bs.toast', () => { toastElement.remove(); });
    }

    function updateCartBadge(count) {
        const cartLink = document.querySelector('.cart-badge'); let badge = document.getElementById('cartCount');
  if (count > 0) { if (!badge) { badge = document.createElement('span'); badge.className = 'cart-count'; badge.id = 'cartCount'; cartLink.appendChild(badge); } badge.textContent = count; }
        else if (badge) { badge.remove(); }
    }

    document.getElementById('productModal').addEventListener('click', (event) => {
        if (event.target === event.currentTarget) {
            const productModal = bootstrap.Modal.getInstance(event.currentTarget);
     if (productModal) { productModal.hide(); }
        }
    });

  // When opening modal, disable Add to cart if stock is 0 or availability not Disponible
    document.querySelectorAll('.product-card').forEach(card => {
     card.addEventListener('click', (event) => {
     if (event.target.closest('.add-to-cart-btn')) return;
            const availability = (card.dataset.availability || '').trim();
     const stock = parseInt(card.dataset.stock || '0');
 const modalButton = document.getElementById('modalAddToCartBtn');
const availabilityBadge = document.getElementById('modalProductAvailability');
            const isAvailable = availability === 'Disponible' && stock > 0;
 if (isAvailable) { availabilityBadge.className='badge bg-success fs-6'; availabilityBadge.innerHTML='<i class="fas fa-check me-1"></i>Disponible'; modalButton.disabled=false; }
    else { availabilityBadge.className='badge bg-danger fs-6'; availabilityBadge.innerHTML='<i class="fas fa-times me-1"></i>Agotado'; modalButton.disabled=true; }
        });
    });
</script>