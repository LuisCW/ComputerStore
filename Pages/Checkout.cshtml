@page
@model ComputerStore.Pages.CheckoutModel

<div class="container mt-4">
    <h2 class="mb-4 text-center">Finalizar Compra</h2>

    @if (Model.ProductosCarrito == null || !Model.ProductosCarrito.Any())
    {
        <div class="alert alert-warning text-center">
            <i class="fas fa-shopping-cart me-2"></i>
            Tu carrito está vacío. <a href="/Products" class="btn btn-primary ms-2">Ver productos</a>
        </div>
        return;
    }

    <!-- Mostrar errores de validación -->
    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger">
            <h6><i class="fas fa-exclamation-triangle me-2"></i>Por favor corrige los siguientes errores:</h6>
            <ul class="mb-0">
                @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                {
                    <li>@error.ErrorMessage</li>
                }
            </ul>
        </div>
    }

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-primary text-white py-3">
                    <h4 class="mb-0 text-center"><i class="fas fa-credit-card me-2"></i>Método de Pago</h4>
                </div>
                <div class="card-body p-4">
                    <form method="post" asp-page-handler="RealizarPago" id="formPago">
                        @Html.AntiForgeryToken()
                        
                        <!-- Indicador de carga -->
                        <div id="loadingIndicator" class="text-center" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Procesando...</span>
                            </div>
                            <p class="mt-2">Procesando su pago, por favor espere...</p>
                        </div>

                        <div id="paymentForm">
                            <div class="payment-methods mb-4">
                                <div class="row g-3">
                                    <div class="col-6 col-md-3">
                                        <input type="radio" name="MetodoPago" value="TARJETA" id="metodoTarjeta" 
                                               class="btn-check" required asp-for="MetodoPago" />
                                        <label for="metodoTarjeta" class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center">
                                            <i class="bi bi-credit-card me-2"></i> Tarjeta
                                        </label>
                                        <span asp-validation-for="MetodoPago" class="text-danger small"></span>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <input type="radio" name="MetodoPago" value="PSE" id="metodoPSE" 
                                               class="btn-check" required asp-for="MetodoPago" />
                                        <label for="metodoPSE" class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center">
                                            <i class="bi bi-bank me-2"></i> PSE
                                        </label>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <input type="radio" name="MetodoPago" value="EFECTY" id="metodoEfecty" 
                                               class="btn-check" required asp-for="MetodoPago" />
                                        <label for="metodoEfecty" class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center">
                                            <i class="bi bi-cash-stack me-2"></i> Efecty
                                        </label>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <input type="radio" name="MetodoPago" value="NEQUI" id="metodoNequi" 
                                               class="btn-check" required asp-for="MetodoPago" />
                                        <label for="metodoNequi" class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center">
                                            <i class="bi bi-phone me-2"></i> Nequi
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Información de Tarjeta -->
                            <div id="tarjeta-info" class="payment-info" style="display:none;">
                                <div class="card-logos mb-3 d-flex justify-content-center">
                                    <i class="fab fa-cc-visa card-logo me-3" data-card-type="VISA"></i>
                                    <i class="fab fa-cc-mastercard card-logo me-3" data-card-type="MASTERCARD"></i>
                                    <i class="fab fa-cc-amex card-logo me-3" data-card-type="AMEX"></i>
                                    <i class="fab fa-cc-diners-club card-logo" data-card-type="DINERS"></i>
                                </div>

                                <div class="mb-3">
                                    <input type="text" asp-for="NumeroTarjeta" id="numeroTarjeta"
                                           class="form-control form-control-lg" placeholder="Número de Tarjeta" 
                                           maxlength="19" autocomplete="cc-number" />
                                    <div id="cardTypeDisplay" class="form-text mt-1 text-center"></div>
                                    <input type="hidden" asp-for="TipoTarjeta" id="tipoTarjeta" />
                                    <span asp-validation-for="NumeroTarjeta" class="text-danger small"></span>
                                </div>
                                <div class="row g-3">
                                    <div class="col-6">
                                        <input type="text" asp-for="NombreTarjeta" class="form-control form-control-lg"
                                               placeholder="Nombre del Titular" maxlength="50" autocomplete="cc-name" />
                                        <span asp-validation-for="NombreTarjeta" class="text-danger small"></span>
                                    </div>
                                    <div class="col-6">
                                        <input type="text" asp-for="CVV" class="form-control form-control-lg"
                                               placeholder="CVV" maxlength="4" autocomplete="cc-csc" />
                                        <span asp-validation-for="CVV" class="text-danger small"></span>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-6">
                                        <input type="text" asp-for="ExpiracionMes" class="form-control form-control-lg"
                                               placeholder="MM" maxlength="2" autocomplete="cc-exp-month" />
                                        <span asp-validation-for="ExpiracionMes" class="text-danger small"></span>
                                    </div>
                                    <div class="col-6">
                                        <input type="text" asp-for="ExpiracionAnio" class="form-control form-control-lg"
                                               placeholder="AAAA" maxlength="4" autocomplete="cc-exp-year" />
                                        <span asp-validation-for="ExpiracionAnio" class="text-danger small"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Información PSE -->
                            <div id="pse-info" class="payment-info" style="display:none;">
                                <div class="mb-3">
                                    <input type="text" asp-for="DocumentoPSE" class="form-control form-control-lg"
                                           placeholder="Número de Documento" maxlength="15" />
                                    <span asp-validation-for="DocumentoPSE" class="text-danger small"></span>
                                </div>
                                <div class="mb-3">
                                    <select asp-for="BancoPSE" class="form-select form-select-lg">
                                        <option value="">Selecciona tu banco</option>
                                        <option value="1">Bancolombia</option>
                                        <option value="2">Banco de Bogotá</option>
                                        <option value="3">Davivienda</option>
                                        <option value="4">BBVA</option>
                                        <option value="5">Banco de Occidente</option>
                                        <option value="6">Banco Popular</option>
                                        <option value="7">Banco AV Villas</option>
                                        <option value="8">Banco Caja Social</option>
                                        <option value="9">Banco Agrario</option>
                                        <option value="10">Banco Itaú</option>
                                        <option value="11">Scotiabank Colpatria</option>
                                        <option value="12">GNB Sudameris</option>
                                        <option value="13">Banco Pichincha</option>
                                        <option value="14">Bancoomeva</option>
                                        <option value="15">Banco Falabella</option>
                                        <option value="16">Banco Finandina</option>
                                        <option value="17">Banco Coopcentral</option>
                                        <option value="18">Banco Serfinanza</option>
                                        <option value="19">Nequi</option>
                                        <option value="20">Daviplata</option>
                                    </select>
                                    <span asp-validation-for="BancoPSE" class="text-danger small"></span>
                                </div>
                            </div>

                            <!-- Información Efecty -->
                            <div id="efecty-info" class="payment-info" style="display:none;">
                                <div class="mb-3">
                                    <input type="text" asp-for="DocumentoEfecty" class="form-control form-control-lg"
                                           placeholder="Número de Documento" maxlength="15" />
                                    <span asp-validation-for="DocumentoEfecty" class="text-danger small"></span>
                                </div>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Efecty:</strong> Después de confirmar el pago, recibirás un código para realizar el pago en cualquier punto Efecty.
                                </div>
                            </div>

                            <!-- Información Nequi -->
                            <div id="nequi-info" class="payment-info" style="display:none;">
                                <div class="mb-3">
                                    <input type="text" asp-for="CelularNequi" class="form-control form-control-lg"
                                           placeholder="Número de Celular (ej: 3001234567)" maxlength="10" />
                                    <span asp-validation-for="CelularNequi" class="text-danger small"></span>
                                </div>
                                <div class="alert alert-info">
                                    <i class="fas fa-mobile-alt me-2"></i>
                                    <strong>Nequi:</strong> Recibirás una notificación en tu app Nequi para aprobar el pago.
                                </div>
                            </div>

                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-primary btn-lg px-5" id="btnPagar">
                                    <i class="fas fa-credit-card me-2"></i>Realizar Pago
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Resumen de Compra -->
        <div class="col-md-4">
            <div class="card shadow-lg border-0 rounded-4 sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white py-3">
                    <h4 class="mb-0 text-center"><i class="fas fa-receipt me-2"></i>Resumen de Compra</h4>
                </div>
                <div class="card-body p-4">
                    <div class="mb-3">
                        <small class="text-muted">Productos en tu carrito:</small>
                    </div>
                    
                    <div class="order-summary" style="max-height: 300px; overflow-y: auto;">
                        @foreach (var producto in Model.ProductosCarrito)
                        {
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                <div class="flex-grow-1">
                                    <small class="fw-bold d-block">@producto.Name</small>
                                    <small class="text-muted">@producto.Brand</small>
                                </div>
                                <span class="fw-bold text-primary">@producto.Price.ToString("C0")</span>
                            </div>
                        }
                    </div>
                    
                    <hr />
                    <div class="d-flex justify-content-between align-items-center">
                        <strong class="fs-5">Total:</strong>
                        <strong class="fs-4 text-primary">@Model.Total.ToString("C0")</strong>
                    </div>
                    
                    <div class="mt-3 text-center">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1"></i>
                            Pago seguro protegido por SSL
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .payment-info {
        transition: all 0.3s ease;
    }
    
    .card-logo {
        font-size: 2rem;
        opacity: 0.5;
        transition: opacity 0.3s ease;
        cursor: pointer;
    }
    
    .card-logo.active {
        opacity: 1;
        transform: scale(1.1);
    }
    
    .btn-check:checked + .btn-outline-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white;
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
    }
    
    .order-summary::-webkit-scrollbar {
        width: 6px;
    }
    
    .order-summary::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .order-summary::-webkit-scrollbar-thumb {
        background: #0d6efd;
        border-radius: 10px;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }

    .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
</style>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Referencias a elementos
            const form = document.getElementById('formPago');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const paymentForm = document.getElementById('paymentForm');
            const btnPagar = document.getElementById('btnPagar');

            // EVENTO PRINCIPAL: Mostrar/ocultar campos según método de pago
            document.querySelectorAll('input[name="MetodoPago"]').forEach((radio) => {
                radio.addEventListener('change', function() {
                    console.log('Método seleccionado:', this.value);
                    
                    // Ocultar TODAS las secciones primero
                    document.querySelectorAll('.payment-info').forEach(div => {
                        div.style.display = 'none';
                    });
                    
                    // Mostrar la sección correspondiente
                    const targetId = this.value.toLowerCase() + '-info';
                    const targetDiv = document.getElementById(targetId);
                    
                    if (targetDiv) {
                        targetDiv.style.display = 'block';
                        console.log('Mostrando:', targetId);
                    } else {
                        console.error('No se encontró:', targetId);
                    }
                });
            });

            // Formatear número de tarjeta
            const numeroTarjeta = document.getElementById('numeroTarjeta');
            if (numeroTarjeta) {
                numeroTarjeta.addEventListener('input', function() {
                    let value = this.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                    this.value = formattedValue;
                });
            }

            // Validación de solo números
            function numbersOnly(input) {
                input.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9]/g, '');
                });
            }

            // Aplicar a campos que solo permiten números
            const cvv = document.querySelector('input[name="CVV"]');
            const docPSE = document.querySelector('input[name="DocumentoPSE"]');
            const docEfecty = document.querySelector('input[name="DocumentoEfecty"]');
            const celular = document.querySelector('input[name="CelularNequi"]');
            const mes = document.querySelector('input[name="ExpiracionMes"]');
            const anio = document.querySelector('input[name="ExpiracionAnio"]');

            if (cvv) numbersOnly(cvv);
            if (docPSE) numbersOnly(docPSE);
            if (docEfecty) numbersOnly(docEfecty);
            if (celular) numbersOnly(celular);
            if (mes) numbersOnly(mes);
            if (anio) numbersOnly(anio);

            // Validar formulario al enviar
            form.addEventListener('submit', function(e) {
                const selectedMethod = document.querySelector('input[name="MetodoPago"]:checked');
                
                if (!selectedMethod) {
                    e.preventDefault();
                    alert('Por favor selecciona un método de pago');
                    return;
                }

                // Mostrar indicador de carga
                loadingIndicator.style.display = 'block';
                paymentForm.style.display = 'none';
                btnPagar.disabled = true;
            });

            console.log('JavaScript de Checkout inicializado');
        });
    </script>
}