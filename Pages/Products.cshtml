@page
@using Microsoft.AspNetCore.WebUtilities
@model ComputerStore.Pages.ProductsModel
@{
    ViewData["Title"] = "Productos";
}
@functions {
    public string PageUrl(int page)
    {
        var query = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
        foreach (var kv in Request.Query)
        {
            if (string.Equals(kv.Key, "page", StringComparison.OrdinalIgnoreCase)) continue;
            if (!string.IsNullOrEmpty(kv.Value)) query[kv.Key] = kv.Value.ToString();
        }
        query["page"] = page.ToString();
        return QueryHelpers.AddQueryString(Request.Path, query);
    }
}
@inject ComputerStore.Services.LittleCarService CarritoService

<div class="container-fluid px-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="text-center mb-4">
                <i class="fas fa-store me-2 text-primary"></i>
                Catálogo de Productos
            </h2>
        </div>
    </div>

    <!-- Filtros avanzados -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>
                        Filtros de Búsqueda
                        <button class="btn btn-sm btn-outline-light float-end" id="clearFilters">
                            <i class="fas fa-refresh me-1"></i>Limpiar
                        </button>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Búsqueda por texto -->
                        <div class="col-md-3">
                            <label for="searchInput" class="form-label">
                                <i class="fas fa-search me-1"></i>Buscar
                            </label>
                            <input type="text" id="searchInput" class="form-control" 
                                   placeholder="Nombre, marca, descripción...">
                        </div>

                        <!-- Filtro por Categoría -->
                        <div class="col-md-3">
                            <label for="categoryFilter" class="form-label">
                                <i class="fas fa-tags me-1"></i>Categoría
                            </label>
                            <select id="categoryFilter" class="form-select">
                                <option value="">Todas las categorías</option>
                                @foreach (var category in Model.Categorias)
                                {
                                    <option value="@category">@category</option>
                                }
                            </select>
                        </div>

                        <!-- Filtro por Marca -->
                        <div class="col-md-3">
                            <label for="brandFilter" class="form-label">
                                <i class="fas fa-award me-1"></i>Marca
                            </label>
                            <select id="brandFilter" class="form-select">
                                <option value="">Todas las marcas</option>
                                @foreach (var brand in Model.Marcas)
                                {
                                    <option value="@brand">@brand</option>
                                }
                            </select>
                        </div>

                        <!-- Filtro por Disponibilidad -->
                        <div class="col-md-3">
                            <label for="availabilityFilter" class="form-label">
                                <i class="fas fa-check-circle me-1"></i>Disponibilidad
                            </label>
                            <select id="availabilityFilter" class="form-select">
                                <option value="">Todos</option>
                                <option value="Disponible">Disponible</option>
                                <option value="Agotado">Agotado</option>
                            </select>
                        </div>

                        <!-- Filtro por Rango de Precio -->
                        <div class="col-md-6">
                            <label for="priceRange" class="form-label">
                                <i class="fas fa-dollar-sign me-1"></i>Rango de Precio
                            </label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="number" id="minPrice" class="form-control" placeholder="Min" min="0">
                                <span>-</span>
                                <input type="number" id="maxPrice" class="form-control" placeholder="Max" min="0">
                                <button class="btn btn-outline-primary" id="applyPriceFilter">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Ordenar por -->
                        <div class="col-md-3">
                            <label for="sortBy" class="form-label">
                                <i class="fas fa-sort me-1"></i>Ordenar por
                            </label>
                            <select id="sortBy" class="form-select">
                                <option value="name-asc">Nombre A-Z</option>
                                <option value="name-desc">Nombre Z-A</option>
                                <option value="price-asc">Precio: Menor a Mayor</option>
                                <option value="price-desc">Precio: Mayor a Menor</option>
                                <option value="brand-asc">Marca A-Z</option>
                            </select>
                        </div>

                        <!-- Vista -->
                        <div class="col-md-3">
                            <label class="form-label">
                                <i class="fas fa-th me-1"></i>Vista
                            </label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="viewMode" id="gridView" value="grid" checked>
                                <label class="btn btn-outline-primary" for="gridView">
                                    <i class="fas fa-th"></i>
                                </label>
                                <input type="radio" class="btn-check" name="viewMode" id="listView" value="list">
                                <label class="btn btn-outline-primary" for="listView">
                                    <i class="fas fa-list"></i>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resultados y contadores -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div id="resultsCount" class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Mostrando <span id="visibleCount">@Model.PagedProductos.Count</span> de <span id="totalCount">@Model.TotalItems</span> productos
            </div>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-primary" id="toggleFilters">
                <i class="fas fa-filter me-1"></i>Filtros Avanzados
            </button>
        </div>
    </div>

    <!-- Lista de productos -->
    <div id="productList" class="row" data-view="grid">
        @foreach (var producto in Model.PagedProductos)
        {
            var ahorro = (producto.OriginalPrice.HasValue && producto.OriginalPrice.Value > 0 && producto.OriginalPrice.Value > producto.Price)
                ? producto.OriginalPrice.Value - producto.Price
                : 0;
            var pct = (producto.OriginalPrice.HasValue && producto.OriginalPrice.Value > 0 && producto.OriginalPrice.Value > producto.Price)
                ? Math.Round((ahorro / producto.OriginalPrice.Value) * 100)
                : 0;
            var agotado = producto.Stock <= 0 || string.Equals(producto.Availability?.Trim(), "Agotado", StringComparison.OrdinalIgnoreCase);
            <div class="product-col col-md-4 mb-4"
                 data-id="@producto.Id"
                 data-category="@producto.Category"
                 data-brand="@producto.Brand"
                 data-component="@producto.Component"
                 data-color="@producto.Color"
                 data-availability="@producto.Availability"
                 data-stock="@producto.Stock"
                 data-price="@producto.Price"
                 data-name="@producto.Name.ToLower()"
                 data-description="@producto.Description.ToLower()"
                 data-campaign="@producto.CampaignName"
                 data-details='@Html.Raw(Json.Serialize(producto.Details))'>
                <div class="card shadow-sm h-100 product-card position-relative"
                     data-id="@producto.Id"
                     data-name="@producto.Name"
                     data-description="@producto.Description"
                     data-price="@producto.Price"
                     data-brand="@producto.Brand"
                     data-availability="@producto.Availability"
                     data-stock="@producto.Stock"
                     data-campaign="@producto.CampaignName"
                     data-details='@Html.Raw(Json.Serialize(producto.Details))'>
                    @await Html.PartialAsync("_ProductCarousel", producto)
                    @if (agotado)
                    {
                        <span class="badge bg-secondary position-absolute top-0 start-0 m-2">Agotado</span>
                    }
                    else if (pct > 0)
                    {
                        <span class="badge bg-danger position-absolute top-0 start-0 m-2">-@pct% OFF</span>
                    }
                    @if (!string.IsNullOrWhiteSpace(producto.CampaignName))
                    {
                        <span class="badge bg-info position-absolute top-0 end-0 m-2">
                            <i class="fas fa-bullhorn me-1"></i>@producto.CampaignName
                        </span>
                    }
                    <div class="card-body">
                        <h5 class="card-title">@producto.Name</h5>
                        <p class="card-text product-desc-2lines">@producto.Description</p>
                        @if (producto.OriginalPrice.HasValue && producto.OriginalPrice.Value > 0 && producto.OriginalPrice.Value > producto.Price)
                        {
                            <p class="card-text">
                                <span class="text-muted text-decoration-line-through me-2 old-price">$@producto.OriginalPrice.Value.ToString("N0")</span>
                                <span class="fw-bold text-success new-price">$@producto.Price.ToString("N0")</span>
                            </p>
                        }
                        else
                        {
                            <p class="card-text fw-bold new-price">$@producto.Price.ToString("N0")</p>
                        }
                        <div class="d-flex justify-content-between align-items-center">
                            <button class="btn btn-primary details-btn">Ver Detalles</button>
                            <button type="button" class="btn @(agotado?"btn-secondary":"btn-success") btn-sm add-to-cart-btn"
                                    data-product-id="@producto.Id"
                                    data-product-name="@producto.Name"
                                    @(agotado?"disabled":"")>
                                <i class="fas fa-cart-plus me-1"></i>@(agotado?"Agotado":"Agregar")
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Paginación -->
    <div class="row mt-3">
        <div class="col-12 d-flex justify-content-center">
            <nav aria-label="Paginación de productos">
                <ul class="pagination">
                    <li class="page-item @(Model.PageNumber <= 1 ? "disabled" : "")">
                        <a class="page-link" href="#" data-page="@(Model.PageNumber - 1)" aria-label="Anterior">&laquo;</a>
                    </li>
                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                            <a class="page-link" href="#" data-page="@i">@i</a>
                        </li>
                    }
                    <li class="page-item @(Model.PageNumber >= Model.TotalPages ? "disabled" : "")">
                        <a class="page-link" href="#" data-page="@(Model.PageNumber + 1)" aria-label="Siguiente">&raquo;</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- Mensaje cuando no hay resultados -->
    <div id="noResults" class="text-center py-5" style="display: none;">
        <div class="text-muted">
            <i class="fas fa-search fa-3x mb-3"></i>
            <h4>No se encontraron productos</h4>
            <p>Intenta ajustar tus filtros de búsqueda o <button class="btn btn-link p-0" id="clearAllFilters">limpiar todos los filtros</button></p>
        </div>
    </div>
</div>

<!-- Toast para notificaciones -->
<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<!-- Modal de Detalles de Producto -->
<div id="productModal" class="modal fade" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
  <div class="modal-header bg-primary text-white">
       <h5 class="modal-title" id="productModalLabel">
           <i class="fas fa-info-circle me-2"></i>Detalles del Producto
       </h5>
  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>
<div class="modal-body">
<div class="row">
     <div class="col-md-6">
     <div class="carousel slide" data-bs-ride="carousel">
           <div class="carousel-inner"></div>
 <button class="carousel-control-prev" type="button" data-bs-target="#productModal .carousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
         </button>
         <button class="carousel-control-next" type="button" data-bs-target="#productModal .carousel" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
  </button>
        </div>
 </div>
      <div class="col-md-6">
            <h3 id="modalProductName" class="text-primary mb-2"></h3>
      <div id="modalCampaignBadge" class="mb-2"></div>
          <p id="modalProductDescription" class="text-muted mb-3"></p>
   <div class="mb-3">
        <h4 class="text-success">
    <i class="fas fa-tag me-2"></i>
           <span id="modalProductPrice"></span>
           </h4>
      </div>
           <div class="mb-3">
        <h6 class="fw-bold">
   <i class="fas fa-award me-2"></i>Marca: 
    <span id="modalProductBrand" class="text-primary"></span>
        </h6>
    </div>
    <div class="mb-4">
         <h6 class="fw-bold mb-2">
    <i class="fas fa-cogs me-2"></i>Especificaciones:
</h6>
     <div id="modalProductDetails" class="row"></div>
     </div>
       <div class="mb-3">
    <span id="modalProductAvailability" class="badge"></span>
            </div>
   </div>
  </div>
     </div>
     <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">
      <i class="fas fa-times me-1"></i>Cerrar
      </button>
   <button type="button" class="btn btn-primary btn-lg add-to-cart-btn"
          id="modalAddToCartBtn"
                  data-product-id=""
       data-product-name="">
           <i class="fas fa-cart-plus me-2"></i>Agregar al Carrito
      </button>
          </div>
</div>
    </div>
</div>

@Html.AntiForgeryToken()

<script>
    // Descripción a 2 líneas
    const styleClamp = document.createElement('style');
    styleClamp.innerHTML = `.product-desc-2lines{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:3rem}`;
    document.head.appendChild(styleClamp);

    function getQueryParams() {
        const p = new URLSearchParams(window.location.search);
        return {
            q: (p.get('q') || '').trim(),
            category: (p.get('category') || '').trim(),
            component: (p.get('component') || '').trim()
        };
    }

    class ProductFilter {
        constructor() {
            this.products = Array.from(document.querySelectorAll('.product-col'));
            this.urlFilters = getQueryParams();
            this.initializeElements();
            this.bindEvents();
            this.applyUrlFilters();
            this.updateCounter();
        }

        initializeElements() {
            this.searchInput = document.getElementById('searchInput');
            this.categoryFilter = document.getElementById('categoryFilter');
            this.brandFilter = document.getElementById('brandFilter');
            this.availabilityFilter = document.getElementById('availabilityFilter');
            this.minPriceInput = document.getElementById('minPrice');
            this.maxPriceInput = document.getElementById('maxPrice');
            this.sortBy = document.getElementById('sortBy');
            this.viewModeInputs = document.querySelectorAll('input[name="viewMode"]');
            this.clearFiltersBtn = document.getElementById('clearFilters');
            this.noResultsDiv = document.getElementById('noResults');
            this.productList = document.getElementById('productList');
        }

        bindEvents() {
            let searchTimeout;
            this.searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => this.applyFilters(), 300);
            });

            [this.categoryFilter, this.brandFilter, this.availabilityFilter].forEach(filter => {
                filter.addEventListener('change', () => this.applyFilters());
            });

            document.getElementById('applyPriceFilter')?.addEventListener('click', () => this.applyFilters());
            [this.minPriceInput, this.maxPriceInput].forEach(input => {
                input.addEventListener('keypress', (e) => { if (e.key === 'Enter') this.applyFilters(); });
            });

            this.sortBy.addEventListener('change', () => this.sortProducts());

            this.viewModeInputs.forEach(input => {
                input.addEventListener('change', () => this.changeView(input.value));
            });

            this.clearFiltersBtn.addEventListener('click', () => this.clearFilters());
            document.getElementById('clearAllFilters')?.addEventListener('click', () => this.clearFilters());
        }

        applyUrlFilters() {
            // Prellenar desde la URL
            if (this.urlFilters.q) this.searchInput.value = this.urlFilters.q;
            if (this.urlFilters.category) this.categoryFilter.value = this.urlFilters.category;
            // Aplicar inmediatamente
            this.applyFilters();
        }

        applyFilters() {
            const filters = this.getActiveFilters();
            let visibleCount = 0;
            this.products.forEach((product) => {
                const isVisible = this.productMatchesFilters(product, filters);
                if (isVisible) { product.style.display = ''; visibleCount++; }
                else { product.style.display = 'none'; }
            });
            this.updateCounter(visibleCount);
            this.toggleNoResults(visibleCount === 0);
            this.sortProducts();
            this.highlightActiveFilters(filters);
        }

        getActiveFilters() {
            return {
                search: this.searchInput.value.toLowerCase().trim(),
                category: this.categoryFilter.value,
                brand: this.brandFilter.value,
                availability: this.availabilityFilter.value,
                minPrice: parseFloat(this.minPriceInput.value) || 0,
                maxPrice: parseFloat(this.maxPriceInput.value) || Infinity,
                // incluye component proveniente de URL
                component: (this.urlFilters.component || '').toLowerCase()
            };
        }

        productMatchesFilters(product, filters) {
            const dataset = product.dataset;
            const price = parseFloat(dataset.price);
            if (filters.search && !this.searchInProduct(product, filters.search)) { return false; }
            if (filters.category && dataset.category !== filters.category) return false;
            if (filters.brand && dataset.brand !== filters.brand) return false;
            if (filters.availability && dataset.availability !== filters.availability) return false;
            if (filters.component && (dataset.component || '').toLowerCase() !== filters.component) return false;
            if (price < filters.minPrice || price > filters.maxPrice) return false;
            return true;
        }

        searchInProduct(product, searchTerm) {
            const searchableText = [
                product.dataset.name,
                product.dataset.description,
                (product.dataset.brand || '').toLowerCase(),
                (product.dataset.category || '').toLowerCase(),
                (product.dataset.component || '').toLowerCase()
            ].join(' ');
            const searchTerms = searchTerm.split(' ').filter(term => term.length > 0);
            return searchTerms.every(term => searchableText.includes(term));
        }

        sortProducts() {
            const [sortField, sortDirection] = this.sortBy.value.split('-');
            const visibleProducts = this.products.filter(p => p.style.display !== 'none');
            visibleProducts.sort((a, b) => {
                let valueA, valueB;
                switch (sortField) {
                    case 'name': valueA = a.dataset.name; valueB = b.dataset.name; break;
                    case 'price': valueA = parseFloat(a.dataset.price); valueB = parseFloat(b.dataset.price); break;
                    case 'brand': valueA = a.dataset.brand; valueB = b.dataset.brand; break;
                    default: return 0;
                }
                if (sortField === 'price') { return sortDirection === 'asc' ? valueA - valueB : valueB - valueA; }
                else { const comparison = valueA.localeCompare(valueB); return sortDirection === 'asc' ? comparison : -comparison; }
            });
            visibleProducts.forEach((product, index) => { product.style.order = index; });
        }

        changeView(viewMode) {
            if (viewMode === 'list') {
                this.productList.className = 'row list-view';
                this.products.forEach(product => { product.className = product.className.replace('col-md-4', 'col-12'); product.classList.add('list-view'); });
            } else {
                this.productList.className = 'row';
                this.products.forEach(product => { product.className = product.className.replace('col-12', 'col-md-4'); product.classList.remove('list-view'); });
            }
        }

        clearFilters() {
            this.searchInput.value = '';
            this.categoryFilter.value = '';
            this.brandFilter.value = '';
            this.availabilityFilter.value = '';
            this.minPriceInput.value = '';
            this.maxPriceInput.value = '';
            this.sortBy.value = 'name-asc';
            this.urlFilters = { q: '', category: '', component: '' };
            document.querySelectorAll('.filter-active').forEach(el => { el.classList.remove('filter-active'); });
            this.applyFilters();
        }

        highlightActiveFilters(filters) {
            document.querySelectorAll('.filter-active').forEach(el => { el.classList.remove('filter-active'); });
            if (filters.search) this.searchInput.classList.add('filter-active');
            if (filters.category) this.categoryFilter.classList.add('filter-active');
            if (filters.brand) this.brandFilter.classList.add('filter-active');
            if (filters.availability) this.availabilityFilter.classList.add('filter-active');
            if (filters.minPrice > 0) this.minPriceInput.classList.add('filter-active');
            if (filters.maxPrice < Infinity) this.maxPriceInput.classList.add('filter-active');
        }

        updateCounter(visibleCount = null) {
            if (visibleCount === null) { visibleCount = this.products.filter(p => p.style.display !== 'none').length; }
            document.getElementById('visibleCount').textContent = visibleCount;
            document.getElementById('totalCount').textContent = this.products.length;
        }

        toggleNoResults(show) {
            this.noResultsDiv.style.display = show ? 'block' : 'none';
            this.productList.style.display = show ? 'none' : 'flex';
        }
    }

    function updateCartBadge(count) {
        const cartLink = document.querySelector('.cart-badge'); let badge = document.getElementById('cartCount');
        if (count > 0) { if (!badge) { badge = document.createElement('span'); badge.className = 'cart-count'; badge.id = 'cartCount'; cartLink?.appendChild(badge); } badge.textContent = count; }
        else if (badge) { badge.remove(); }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const pf = new ProductFilter();

        // Abrir modal con datos (igual que Index) + validación de stock + URL única
  document.querySelectorAll('.product-card').forEach(card => {
            card.addEventListener("click", (event) => {
   if (event.target.closest('.add-to-cart-btn')) { return; }
    const productId = card.dataset.id;
        const productName = card.dataset.name || card.querySelector('.card-title')?.textContent || '';
       const productDescription = card.dataset.description || card.querySelector('.card-text:not(.fw-bold)')?.textContent || '';
           const productBrand = card.dataset.brand || '';
  const availability = (card.dataset.availability || '').trim();
           const stock = parseInt(card.dataset.stock || '0');
       const campaign = card.dataset.campaign || '';
         
     // Actualizar URL con el ID del producto
     const productSlug = productName.toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)/g, '');
     const newUrl = `${window.location.pathname}?product=${productId}-${productSlug}`;
          window.history.pushState({ productId: productId }, '', newUrl);
        
     const modalButton = document.getElementById('modalAddToCartBtn');
    modalButton.setAttribute('data-product-id', productId);
           modalButton.setAttribute('data-product-name', productName);
             document.getElementById('modalProductName').textContent = productName;
   document.getElementById('modalProductDescription').textContent = productDescription;
                document.getElementById('modalProductBrand').textContent = productBrand || '—';
      const availabilityBadge = document.getElementById('modalProductAvailability');
       const isAvailable = availability === 'Disponible' && stock > 0;
         if (isAvailable) { availabilityBadge.className = 'badge bg-success fs-6'; availabilityBadge.innerHTML = '<i class="fas fa-check me-1"></i>Disponible'; modalButton.disabled = false; }
                else { availabilityBadge.className = 'badge bg-danger fs-6'; availabilityBadge.innerHTML = '<i class="fas fa-times me-1"></i>Agotado'; modalButton.disabled = true; }
       const oldEl = card.querySelector('.old-price');
           const newEl = card.querySelector('.new-price');
           if (oldEl && newEl) {
       document.getElementById('modalProductPrice').innerHTML = `<span class="text-muted text-decoration-line-through me-2">${oldEl.textContent}</span><span class="fw-bold text-success">${newEl.textContent}</span>`;
        } else if (newEl) {
        document.getElementById('modalProductPrice').innerHTML = `<span class="fw-bold">${newEl.textContent}</span>`;
      } else {
     const price = card.dataset.price ? Number(card.dataset.price).toLocaleString() : '';
         document.getElementById('modalProductPrice').innerText = price ? `$${price}` : '';
    }
     const campaignBadge = document.getElementById('modalCampaignBadge');
         if (campaign) { campaignBadge.innerHTML = `<span class="badge bg-info"><i class=\"fas fa-bullhorn me-1\"></i>${campaign}</span>`; }
           else { campaignBadge.innerHTML = ''; }
 const productDetails = JSON.parse(card.dataset.details || '{}');
    const detailsContainer = document.getElementById('modalProductDetails');
   if (Object.keys(productDetails).length > 0) {
          detailsContainer.innerHTML = Object.entries(productDetails)
                .map(([key, value]) => `<div class=\"col-md-6 mb-2\"><strong class=\"text-muted\">${key}:</strong><br><span class=\"text-reset\">${value}</span></div>`)
      .join('');
          } else { detailsContainer.innerHTML = '<div class="col-12 text-muted">Sin especificaciones técnicas disponibles</div>'; }
      setupModalImageCarousel(card);
             const productModal = new bootstrap.Modal(document.getElementById('productModal'));
    productModal.show();
            });
        });

        // Restaurar URL al cerrar el modal
        const productModal = document.getElementById('productModal');
 productModal.addEventListener('hidden.bs.modal', () => {
         const urlParams = new URLSearchParams(window.location.search);
            urlParams.delete('product');
            const baseUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
            window.history.pushState({}, '', baseUrl);
   });

        // Abrir modal si hay un parámetro 'product' en la URL al cargar la página
        const urlParams = new URLSearchParams(window.location.search);
        const productParam = urlParams.get('product');
        if (productParam) {
     const productId = productParam.split('-')[0];
            const card = document.querySelector(`.product-card[data-id="${productId}"]`);
        if (card) {
   card.click();
    }
        }
    });

    function setupModalImageCarousel(productCard) {
        const carouselInner = document.querySelector('#productModal .carousel-inner');
        if (!carouselInner) return;
        carouselInner.innerHTML = '';
        const carousel = productCard.querySelector('.carousel');
        const images = [];
        if (carousel) {
            const carouselItems = carousel.querySelectorAll('.carousel-item img');
            carouselItems.forEach(img => { images.push({ src: img.src, alt: img.alt }); });
        } else {
            const mainImage = productCard.querySelector('img');
            if (mainImage) { images.push({ src: mainImage.src, alt: mainImage.alt }); }
        }
        if (images.length > 0) {
            images.forEach((image, index) => {
                const isActive = index === 0 ? 'active' : '';
                const item = document.createElement('div');
                item.className = `carousel-item ${isActive}`;
                item.innerHTML = `<img src="${image.src}" class="d-block w-100" alt="${image.alt}" style="height: 400px; object-fit: contain; background: #f8f9fa;">`;
                carouselInner.appendChild(item);
            });
            let indicators = document.querySelector('#productModal .carousel-indicators');
            if (!indicators) {
                indicators = document.createElement('div');
                indicators.className = 'carousel-indicators';
                const car = document.querySelector('#productModal .carousel');
                if (car) { car.insertBefore(indicators, carouselInner); }
            }
            indicators.innerHTML = '';
            images.forEach((_, index) => {
                const indicator = document.createElement('button');
                indicator.type = 'button';
                indicator.setAttribute('data-bs-target', '#productModal .carousel');
                indicator.setAttribute('data-bs-slide-to', index);
                indicator.className = index === 0 ? 'active' : '';
                indicators.appendChild(indicator);
            });
        } else {
            const item = document.createElement('div');
            item.className = 'carousel-item active';
            item.innerHTML = `<div class="d-flex align-items-center justify-content-center" style="height: 400px; background: #f8f9fa;"><div class="text-center text-muted"><i class="fas fa-image fa-4x mb-3"></i><p>Sin imagen disponible</p></div></div>`;
            carouselInner.appendChild(item);
        }
    }

    // Agregar al carrito (Index-like)
    document.addEventListener('click', (e) => {
        if (e.target.closest('.add-to-cart-btn')) {
            e.preventDefault(); e.stopPropagation();
            const button = e.target.closest('.add-to-cart-btn');
            const productId = button.getAttribute('data-product-id');
            const productName = button.getAttribute('data-product-name');
            if (productId) { addToCart(productId, productName, button); }
        }
    });

    async function addToCart(productId, productName, button) {
        const originalText = button.innerHTML; const originalDisabled = button.disabled;
        try {
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Agregando...'; button.disabled = true;
            const formData = new FormData(); formData.append('id', productId);
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
            const response = await fetch('?handler=AgregarAlCarrito', { method: 'POST', body: formData });
            if (!response.ok) { throw new Error(`Error HTTP: ${response.status}`); }
            const result = await response.json();
            if (result.success) {
                showToast(`${result.productName} agregado al carrito`, 'success');
                updateCartBadge(result.cartCount);
                button.innerHTML = '<i class="fas fa-check me-1"></i>¡Agregado!';
                button.classList.add('btn-success'); button.classList.remove('btn-primary');
                const modal = document.querySelector('.modal.show'); if (modal) { bootstrap.Modal.getInstance(modal).hide(); }
                setTimeout(() => { button.innerHTML = originalText; button.classList.remove('btn-success'); button.classList.add('btn-success'); button.disabled = originalDisabled; }, 2000);
            } else {
                if (result.requiresLogin) { showLoginModal(result.message); }
                else { throw new Error(result.message || 'Error al agregar producto'); }
            }
        } catch (error) {
            showToast(`Error: ${error.message}`, 'error'); button.innerHTML = originalText; button.disabled = originalDisabled;
        }
    }

    function showLoginModal(message) {
        let loginModal = document.getElementById('loginRequiredModal');
        if (!loginModal) {
            loginModal = document.createElement('div');
            loginModal.id = 'loginRequiredModal';
            loginModal.className = 'modal fade';
            loginModal.innerHTML = `
      <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
 <div class="modal-header bg-warning text-dark">
   <h5 class="modal-title"><i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión Requerido</h5>
           <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
     </div>
            <div class="modal-body text-center">
     <i class="fas fa-shopping-cart fa-3x text-warning mb-3"></i>
 <p class="mb-3">${message}</p>
       <p class="text-muted">Para acceder al carrito de compras y realizar pedidos, necesitas tener una cuenta.</p>
            </div>
        <div class="modal-footer justify-content-center">
               <a href="/Account/Login" class="btn btn-primary"><i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión</a>
  <a href="/Account/Register" class="btn btn-success"><i class="fas fa-user-plus me-2"></i>Crear Cuenta</a>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-2"></i>Cancelar</button>
     </div>
     </div>
       `;
          document.body.appendChild(loginModal);
      }
        const modal = new bootstrap.Modal(loginModal);
  modal.show();
    }

    function showToast(message, type = 'success') {
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) { toastContainer = document.createElement('div'); toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3'; document.body.appendChild(toastContainer); }
        const toastId = 'toast-' + Date.now(); const bgClass = type === 'success' ? 'bg-success' : 'bg-danger'; const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
        const toastHtml = `
  <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="4000">
    <div class="toast-header ${bgClass} text-white">
       <i class="${icon} me-2"></i>
         <strong class="me-auto">${type === 'success' ? '¡Éxito!' : 'Error'}</strong>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
         </div>
                <div class="toast-body">
    ${message}
    ${type === 'success' ? `
               <div class="mt-2">
<button class="btn btn-primary btn-sm me-2" onclick="window.location.href='/LittleCar'">
      <i class="fas fa-shopping-cart me-1"></i>Ver Carrito
       </button>
         <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="toast">
     <i class="fas fa-shopping-bag me-1"></i>Seguir Comprando
        </button>
    </div>` : ''}
     </div>
   </div>`;
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = document.getElementById(toastId); const toast = new bootstrap.Toast(toastElement); toast.show();
        toastElement.addEventListener('hidden.bs.toast', () => { toastElement.remove(); });
    }

    // Paginación: manejar click y navegar preservando query params
    document.addEventListener('click', function(e) {
        const a = e.target.closest('.pagination .page-link');
        if (!a) return;
        e.preventDefault();
        const page = a.getAttribute('data-page');
        if (!page) return;
        const params = new URLSearchParams(window.location.search);
        params.set('page', page);
        // mantener otros parámetros
        window.location.href = window.location.pathname + '?' + params.toString();
    });
</script>

<style>
    /* Asegura que el texto dentro del modal sea claro en modo oscuro */
    body.dark-mode #productModal .text-dark {
        color: #f8f9fa !important;
    }

    /* Paginación: adaptaciones para modo oscuro */
    body.dark-mode .pagination {
   background: rgba(255,255,255,0.02);
        border-radius: 6px;
      padding: 6px;
    }
    body.dark-mode .pagination .page-item .page-link {
        color: #cbd5e1;
        background: #0b1220;
        border: 1px solid rgba(255,255,255,0.06);
    }
    body.dark-mode .pagination .page-item.active .page-link {
        background: linear-gradient(90deg,#2563eb,#3b82f6) !important;
color: #fff !important;
        border-color: #2563eb !important;
    }
    body.dark-mode .pagination .page-item.disabled .page-link { opacity: .5; pointer-events: none; }

    /* Efecto hover en las product cards */
    .product-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .product-card:hover {
        transform: translateY(-8px);
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15) !important;
    }

    body.dark-mode .product-card:hover {
        box-shadow: 0 12px 24px rgba(59, 130, 246, 0.3) !important;
    }

    .product-card .btn {
        transition: all 0.2s ease;
    }

    .product-card:hover .btn-primary {
        transform: scale(1.05);
    }
</style>

